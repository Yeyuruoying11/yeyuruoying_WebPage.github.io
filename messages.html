<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€æ¿ - å¤œé›¨è‹¥ç›ˆ</title>
    <link rel="stylesheet" href="style.css?v=2.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js';
        
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBoF8iDEYaz-nDz37c3Zm9x8Of4ULNtZw4",
            authDomain: "mywebsite-22e7d.firebaseapp.com",
            projectId: "mywebsite-22e7d",
            storageBucket: "mywebsite-22e7d.firebasestorage.app",
            messagingSenderId: "482028113611",
            appId: "1:482028113611:web:fb03d4a33b4adfba15154e",
            measurementId: "G-ZB3S3902WD"
        };
        
        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // å…¨å±€å˜é‡
        window.db = db;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.collection = collection;
        window.orderBy = orderBy;
        window.query = query;
        window.serverTimestamp = serverTimestamp;
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            loadMessages();
            
            // ç»‘å®šæäº¤è¡¨å•äº‹ä»¶
            const form = document.getElementById('messageForm');
            const submitBtn = document.getElementById('submitBtn');
            
            if (form && submitBtn) {
                console.log('æ‰¾åˆ°è¡¨å•å’ŒæŒ‰é’®ï¼Œç»‘å®šäº‹ä»¶...');
                
                // è¡¨å•æäº¤äº‹ä»¶
                form.addEventListener('submit', submitMessage);
                
                // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯å…¼å®¹ï¼‰
                submitBtn.addEventListener('click', function(e) {
                    console.log('æŒ‰é’®è¢«ç‚¹å‡»');
                    e.preventDefault();
                    submitMessage(e);
                });
                
                // è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼ˆç§»åŠ¨ç«¯ï¼‰
                submitBtn.addEventListener('touchend', function(e) {
                    console.log('æŒ‰é’®è¢«è§¦æ‘¸');
                    e.preventDefault();
                    submitMessage(e);
                });
            } else {
                console.error('æ‰¾ä¸åˆ°è¡¨å•æˆ–æŒ‰é’®å…ƒç´ ');
            }
        });
        
        // æäº¤ç•™è¨€
        async function submitMessage(e) {
            console.log('submitMessage å‡½æ•°è¢«è°ƒç”¨');
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const name = document.getElementById('userName').value.trim();
            const message = document.getElementById('userMessage').value.trim();
            
            console.log('è¡¨å•æ•°æ®:', { name, message });
            
            if (!name || !message) {
                alert('è¯·å¡«å†™å§“åå’Œç•™è¨€å†…å®¹ï¼');
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            
            try {
                console.log('å¼€å§‹æäº¤åˆ°Firebase...');
                await addDoc(collection(db, 'messages'), {
                    name: name,
                    message: message,
                    timestamp: serverTimestamp(),
                    createdAt: new Date().toISOString()
                });
                
                console.log('æäº¤æˆåŠŸ');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('messageForm').reset();
                
                // é‡æ–°åŠ è½½ç•™è¨€
                loadMessages();
                
                alert('ç•™è¨€æäº¤æˆåŠŸï¼');
            } catch (error) {
                console.error('æäº¤ç•™è¨€å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼é”™è¯¯ä¿¡æ¯: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = 'å‘è¡¨ç•™è¨€';
            }
        }
        
        // åŠ è½½ç•™è¨€
        async function loadMessages() {
            console.log('å¼€å§‹åŠ è½½ç•™è¨€...');
            try {
                const q = query(collection(db, 'messages'), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                if (querySnapshot.empty) {
                    messagesContainer.innerHTML = '<p class="no-messages">æš‚æ— ç•™è¨€ï¼Œå¿«æ¥ç•™ä¸‹ç¬¬ä¸€æ¡ç•™è¨€å§ï¼</p>';
                    console.log('æ²¡æœ‰æ‰¾åˆ°ç•™è¨€');
                    return;
                }
                
                console.log('æ‰¾åˆ°', querySnapshot.size, 'æ¡ç•™è¨€');
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const messageElement = createMessageElement(data);
                    messagesContainer.appendChild(messageElement);
                });
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error);
                document.getElementById('messagesContainer').innerHTML = '<p class="error-message">åŠ è½½ç•™è¨€å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼</p>';
            }
        }
        
        // åˆ›å»ºç•™è¨€å…ƒç´ 
        function createMessageElement(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-item';
            
            const date = data.timestamp ? 
                new Date(data.timestamp.seconds * 1000).toLocaleString('zh-CN') : 
                new Date(data.createdAt).toLocaleString('zh-CN');
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-name">${escapeHtml(data.name)}</span>
                    <span class="message-date">${date}</span>
                </div>
                <div class="message-content">${escapeHtml(data.message)}</div>
            `;
            
            return messageDiv;
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.submitMessage = submitMessage;
        window.loadMessages = loadMessages;
    </script>
</head>
<body>
    <div class="messages-container">
        <div class="messages-card">
            <div class="messages-header">
                <h1 class="messages-title">ğŸ’¬ ç•™è¨€æ¿</h1>
                <p class="messages-subtitle">æ¬¢è¿ç•™ä¸‹æ‚¨çš„è¶³è¿¹</p>
            </div>
            
            <!-- ç•™è¨€è¡¨å• -->
            <div class="message-form-section">
                <h2>å†™ä¸‹ç•™è¨€</h2>
                <form id="messageForm" class="message-form">
                    <div class="form-group">
                        <label for="userName">å§“å *</label>
                        <input type="text" id="userName" name="userName" required maxlength="20" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                    </div>
                    <div class="form-group">
                        <label for="userMessage">ç•™è¨€å†…å®¹ *</label>
                        <textarea id="userMessage" name="userMessage" required maxlength="500" rows="4" placeholder="è¯·è¾“å…¥ç•™è¨€å†…å®¹..."></textarea>
                    </div>
                    <button type="submit" id="submitBtn" class="submit-button">å‘è¡¨ç•™è¨€</button>
                </form>
            </div>
            
            <!-- ç•™è¨€åˆ—è¡¨ -->
            <div class="messages-list-section">
                <h2>æ‰€æœ‰ç•™è¨€</h2>
                <div id="messagesContainer" class="messages-list">
                    <p class="loading-message">æ­£åœ¨åŠ è½½ç•™è¨€...</p>
                </div>
            </div>
            
            <div class="messages-actions">
                <a href="about.html" class="back-button">â† è¿”å›ä¸ªäººä»‹ç»</a>
                <a href="index.html" class="home-button">ğŸ  å›åˆ°é¦–é¡µ</a>
            </div>
        </div>
    </div>
</body>
</html> 